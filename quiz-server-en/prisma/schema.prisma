generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int           @id @default(autoincrement())
  name               String?
  email              String?       @unique
  createdAt          DateTime      @default(now())
  uuid               String?       @unique
  emailSequenceState Json?
  geo                String?
  results            UserResult[]
  sessions           UserSession[]
}

model Quiz {
  id             Int             @id @default(autoincrement())
  title          String          @db.VarChar(255)
  titleAdm       String          @db.VarChar(255)
  description    String?         @db.Text
  descriptionAdm String?         @db.Text
  descrip        String?         @db.Text
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  categoryId     Int?
  finalPage      String?         @db.Text
  firstPage      String?         @db.Text
  isActive       Boolean         @default(true)
  previewImage   String?         @db.VarChar(255)
  rating         Float?
  resultMessages String?         @db.Text
  quizShortTitle String          @db.VarChar(255)
  quizInfo       String?         @db.Text
  isMainView     Boolean         @default(false)
  type           String          @default("POINTS") @db.VarChar(20)
  emailJobs      EmailJob[]
  emailTemplates EmailTemplate[]
  questions      Question[]
  category       Category?       @relation(fields: [categoryId], references: [id])
  results        UserResult[]
  sessions       UserSession[]

  @@index([categoryId], map: "Quiz_categoryId_fkey")
}

model Question {
  id      Int      @id @default(autoincrement())
  quizId  Int
  text    String   @db.Text
  order   Int?
  image   String?  @db.VarChar(255)
  answers Answer[]
  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId], map: "Question_quizId_fkey")
}

model Answer {
  id         Int      @id @default(autoincrement())
  questionId Int
  text       String   @db.VarChar(255)
  isCorrect  Boolean
  points     Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId], map: "Answer_questionId_fkey")
}

model Category {
  id      Int    @id @default(autoincrement())
  name    String @db.VarChar(100)
  quizzes Quiz[]
}

model UserSession {
  id                   Int       @id @default(autoincrement())
  quizId               Int?
  userId               String?
  sessionId            String    @unique
  currentQuestionIndex Int       @default(0)
  correctAnswersCount  Int       @default(0)
  totalPoints          Int       @default(0)
  answers              Json
  browserInfo          Json
  createdAt            DateTime  @default(now())
  updatedAt            DateTime? @updatedAt
  quiz                 Quiz?     @relation(fields: [quizId], references: [id])
  user                 User?     @relation(fields: [userId], references: [uuid])

  @@index([quizId], map: "UserSession_quizId_fkey")
  @@index([userId], map: "UserSession_userId_fkey")
}

model UserResult {
  id        Int      @id @default(autoincrement())
  userId    String?
  quizId    Int?
  score     Int
  answers   Json
  sessionId String?
  createdAt DateTime @default(now())
  geo       String?
  refSource String?  @map("ref_source") @db.VarChar(255)
  quiz      Quiz?    @relation(fields: [quizId], references: [id])
  user      User?    @relation(fields: [userId], references: [uuid])

  @@index([quizId])
  @@index([userId])
}

model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  createdAt DateTime @default(now())
}

model EmailTemplate {
  id         Int     @id @default(autoincrement())
  app        String
  geo        String
  sequenceId Int
  step       Int
  quizId     Int?
  subject    String  @db.VarChar(255)
  html       String  @db.Text
  delayHours Int
  bodyText   String? @db.Text
  quiz       Quiz?   @relation(fields: [quizId], references: [id], map: "fk_emailtemplate_quiz")

  @@unique([app, geo, sequenceId, step])
  @@unique([quizId, sequenceId, step], map: "uk_quiz_sequence_step")
  @@index([quizId], map: "idx_quizId")
}

model EmailJob {
  id                   Int                @id @default(autoincrement())
  userUuid             String
  templateId           Int
  quizId               Int
  chainType            EmailJob_chainType @default(PERSONAL)
  quizCountAtStart     Int                @default(1)
  status               String             @default("pending") @db.VarChar(50)
  scheduledAt          DateTime
  sentAt               DateTime?
  attempts             Int                @default(0)
  mergeWindowExpiresAt DateTime?          @db.DateTime(0)
  rootQuizId           Int?
  quiz                 Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_emailjob_quiz")

  @@index([userUuid])
  @@index([status])
  @@index([scheduledAt, status])
  @@index([chainType], map: "idx_chainType")
  @@index([userUuid, mergeWindowExpiresAt], map: "idx_merge_window")
  @@index([quizId], map: "idx_quizId")
  @@index([rootQuizId], map: "idx_root_quiz")
  @@index([userUuid, mergeWindowExpiresAt, status], map: "idx_user_window_status")
}

model PendingQuizEmail {
  id             Int       @id @default(autoincrement())
  sessionId      String
  quizId         Int
  quizTitle      String
  score          Int
  correctAnswers Int
  totalQuestions Int
  sendAfter      DateTime
  createdAt      DateTime  @default(now())
  lastAttemptAt  DateTime?
  retryCount     Int       @default(0)
  resetCount     Int       @default(0)
  answer         String?   @db.Text
  refSource      String?   @db.VarChar(255)
}

model Page {
  id        Int       @id @default(autoincrement())
  slug      String    @unique(map: "slug") @db.VarChar(100)
  title     String    @db.VarChar(255)
  content   String    @db.Text
  isActive  Boolean?  @default(true)
  createdAt DateTime? @default(now()) @db.DateTime(0)
  updatedAt DateTime? @default(now()) @db.DateTime(0)

  @@index([slug], map: "slug_2")
}

enum EmailJob_chainType {
  PERSONAL
  GENERAL
}
